if (
    echo "127.0.0.1" |
        ~/.ssh/scripts/functions/ssh_host_available
); then
    available_nodes=("127.0.0.1")
else
    nodes=(
        $(printf "r6525-7773x-%s\n" {1..9})
        $(printf "dgx-a100-%s\n" {1..9})
    )

    available_nodes=($(
        for ((i = 0; i < ${#nodes[@]}; i++)); do
            (
                echo "${nodes[$i]}" |
                    ~/.ssh/scripts/functions/ssh_host_available &&
                    echo "${nodes[$i]}"
            ) &
        done
    )
    )
fi


if [ ${#available_nodes[@]} -eq 1 ]; then
    hostname="$(echo "${available_nodes[0]}" | $HOME/.ssh/scripts/functions/ssh_hostname)"
    username="c01sile"
    if [ "${hostname}" == "127.0.0.1" ]; then
        username="root"
    fi
    # Set hostname
    $(perl -i -p0e "s/(HostName\s+).*/\${1}${hostname}/g" "$HOME/.ssh/dev_container_config")
    # Set username
    $(perl -i -p0e "s/(User\s+).*/\${1}${username}/g" "$HOME/.ssh/dev_container_config")
else
    if [ ${#available_nodes[@]} -gt 1 ]; then
        echo "dev-container available on multiple nodes:" >&2
        printf "\t- %s\n" "${available_nodes[@]}" >&2
    else
        echo "dev-container not available on any node." >&2
    fi
fi

exit 0

# echo "commands:"
# printf "%s\n" "${commands[@]}"

# eval "$commands"
# echo $?

# if [ $(echo r6525-7773x-1 | ~/.ssh/scripts/functions/ssh_host_available)$? -eq 0 ]; then
#     echo "yes"
# else
#     echo "no"
# fi
